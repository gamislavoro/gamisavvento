<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GAMis Avvento 2025</title>
  <meta name="theme-color" content="#b91c1c"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* SAFE MODE & layout */
    .card{box-shadow:0 2px 10px rgba(2,6,23,.06),0 16px 40px rgba(2,6,23,.08)}
    .chip{display:inline-flex;align-items:center;justify-content:center;padding:.38rem .62rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:600;font-size:.85rem;cursor:pointer}
    .chip[aria-pressed="true"]{background:#b91c1c;color:#fff;border-color:#b91c1c}
    .swatch{width:26px;height:26px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px #e5e7eb;cursor:pointer}
    .swatch[aria-selected="true"]{box-shadow:0 0 0 2px #b91c1c}
    .step{width:32px;height:32px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
    .btn{display:inline-flex;align-items:center;justify-content:center;font-weight:700;border-radius:12px}
    .btn-primary{background:#b91c1c;color:#fff;padding:.75rem 1rem} .btn-primary:hover{background:#991b1b}
    .btn-ghost{background:#fff;border:1px solid #ef4444;color:#b91c1c;padding:.75rem 1rem} .btn-ghost:hover{background:#fee2e2}

    /* livelli sicuri: niente overlay che blocca i click */
    main, #prodotti, #preordina, article.card { position: relative; z-index: 10; }

    /* banner errori JS */
    #jsError{position:fixed;left:0;right:0;top:0;z-index:50;display:none}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- HEADER con logo centrato -->
  <header class="bg-white/90 backdrop-blur sticky top-0 z-40 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 md:px-6 h-18 md:h-24 flex items-center justify-center">
      <!-- Inserisci QUI l'URL del logo (può essere assoluto o relativo) -->
      <img id="logoTop" alt="Logo Seminario" class="h-12 md:h-16 w-auto"" src="https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/logo.png"/>
    </div>
    <div class="bg-white/90 backdrop-blur sticky top-0 z-40 border-b border-slate-200 transition-transform duration-300 will-change-transform">
    </div>
  </header>

  <!-- JS error banner -->
  <div id="jsError" class="mx-auto max-w-6xl px-4 md:px-6 py-2">
    <div class="bg-red-600 text-white rounded-lg px-4 py-2 shadow">Errore Javascript: <span id="jsErrorMsg"></span></div>
  </div>

  <!-- HERO SAFE MODE: nessun overlay assoluto che copre -->
  <section class="relative">
  <!-- immagine di sfondo -->
  <div id="heroBgSafe" 
       class="w-full bg-cover bg-center min-h-[500px] md:min-h-[600px]" 
       style="background-image:url('https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/hero.jpg')">
  </div>

  <!-- overlay scuro facoltativo -->
  <div class="absolute inset-0 bg-black/40"></div>

  <!-- testo sopra immagine -->
  <div class="absolute inset-0 flex items-center justify-center">
    <div class="text-center text-white px-4">
      <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
        A Natale dona speranza
      </h1>
      <p class="mt-3 text-lg text-white/90">
        Scegli i prodotti e ci aiuti a pianificare la raccolta fondi.
      </p>
      <div class="mt-5 flex gap-2 justify-center">
        <a href="#prodotti" class="btn btn-primary">Scegli i prodotti</a>
        <a href="#causa" class="btn btn-ghost">Scopri la causa</a>
      </div>
    </div>
  </div>
</section>


  <main class="max-w-6xl mx-auto px-4 md:px-6">
    <!-- Titolo + Totale -->
    <div class="py-8 flex items-center justify-between border-b border-slate-200 mb-6">
      <h2 class="text-2xl font-bold">Prodotti</h2>
      <div id="totaleTop" class="text-xl font-semibold text-slate-700">Totale stimato: € 0,00</div>
    </div>

    <!-- PRODOTTI -->
    <section id="prodotti" class="py-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

        <!-- BIRRA -->
        <article id="card-birra" class="bg-white rounded-2xl card overflow-hidden" data-kind="birra">
          <!-- Inserisci QUI l'URL dell'immagine birra -->
          <img id="img-birra" class="w-full aspect-square object-cover" alt="Birra" src="https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/birra.jpg" data-zoomable/>
          <div class="p-4 space-y-4">
            <header class="flex items-center justify-between">
              <h3 class="font-semibold">Birra</h3>
              <span class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-700 border border-sky-200">artigianale</span>
            </header>
            <p class="text-sm text-slate-600">Birra artigianale selezionata, disponibile in confezione da 6 bottiglie, ideale per brindare insieme.</p>
            <div>
              <div class="text-xs text-slate-500 mb-2">Formato</div>
              <div class="flex flex-wrap gap-2" data-chip-group="formato">
                <button type="button" class="chip" aria-pressed="true" data-value="Cassa da 6">Cassa da 6</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Variante corrente</span>
              <div class="inline-flex items-center gap-2">
                <button type="button" class="step" data-draft-stepper data-delta="-1">–</button>
                <span class="min-w-[1.5ch] text-center" data-draft-qty>0</span>
                <button type="button" class="step" data-draft-stepper data-delta="1">+</button>
              </div>
            </div>
            <button type="button" class="btn btn-ghost w-full" data-add-variant>+ Aggiungi variante</button>
            <div class="space-y-2" data-list></div>
          </div>
        </article>

        <!-- FELPA -->
        <article id="card-felpa" class="bg-white rounded-2xl card overflow-hidden" data-kind="felpa">
          <!-- Inserisci QUI l'URL dell'immagine felpa -->
          <img id="img-felpa" class="w-full aspect-square object-cover" alt="Felpa" src="https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/felpa.jpg" data-zoomable/>
          <div class="p-4 space-y-4">
            <header class="flex items-center justify-between">
              <h3 class="font-semibold">Felpa</h3>
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">invernale</span>
            </header>
            <p class="text-sm text-slate-600">Felpa comoda e calda, perfetta per l’inverno, disponibile in vari colori e taglie.</p>
            <div>
              <div class="text-xs text-slate-500 mb-2">Colore</div>
              <div class="flex items-center gap-2" data-swatch-group="colore">
                <button type="button" class="swatch" style="background:#111827" data-value="Nero" aria-selected="true" title="Nero"></button>
                <button type="button" class="swatch" style="background:#cbd5e1" data-value="Grigio" aria-selected="false" title="Grigio"></button>
                <button type="button" class="swatch" style="background:#7f1d1d" data-value="Bordeaux" aria-selected="false" title="Bordeaux"></button>
                <button type="button" class="swatch" style="background:#14532d" data-value="Verde bosco" aria-selected="false" title="Verde bosco"></button>
                <button type="button" class="swatch" style="background:#1e3a8a" data-value="Blu navy" aria-selected="false" title="Blu navy"></button>
              </div>
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-2">Taglia</div>
              <div class="flex flex-wrap gap-2" data-chip-group="taglia">
                <button type="button" class="chip" aria-pressed="true" data-value="S">S</button>
                <button type="button" class="chip" aria-pressed="false" data-value="M">M</button>
                <button type="button" class="chip" aria-pressed="false" data-value="L">L</button>
                <button type="button" class="chip" aria-pressed="false" data-value="XL">XL</button>
                <button type="button" class="chip" aria-pressed="false" data-value="XXL">XXL</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Variante corrente</span>
              <div class="inline-flex items-center gap-2">
                <button type="button" class="step" data-draft-stepper data-delta="-1">–</button>
                <span class="min-w-[1.5ch] text-center" data-draft-qty>0</span>
                <button type="button" class="step" data-draft-stepper data-delta="1">+</button>
              </div>
            </div>
            <button type="button" class="btn btn-ghost w-full" data-add-variant>+ Aggiungi variante</button>
            <div class="space-y-2" data-list></div>
          </div>
        </article>

        <!-- CAPPELLO -->
        <article id="card-cappello" class="bg-white rounded-2xl card overflow-hidden" data-kind="cappello">
          <!-- Inserisci QUI l'URL dell'immagine cappello -->
          <img id="img-cappello" class="w-full aspect-square object-cover" alt="Cappello" src="https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/cappello.jpg" data-zoomable/>
          <div class="p-4 space-y-4">
            <header class="flex items-center justify-between">
              <h3 class="font-semibold">Cappello</h3>
              <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 border border-indigo-200">lana</span>
            </header>
            <p class="text-sm text-slate-600">Cappello giovane e pratico, per affrontare il freddo con stile.</p>
            <div>
              <div class="text-xs text-slate-500 mb-2">Colore</div>
              <div class="flex items-center gap-2" data-swatch-group="colore">
                <button type="button" class="swatch" style="background:#111827" data-value="Nero" aria-selected="true" title="Nero"></button>
                <button type="button" class="swatch" style="background:#cbd5e1" data-value="Grigio" aria-selected="false" title="Grigio"></button>
                <button type="button" class="swatch" style="background:#ef4444" data-value="Rosso" aria-selected="false" title="Rosso"></button>
                <button type="button" class="swatch" style="background:#16a34a" data-value="Verde" aria-selected="false" title="Verde"></button>
                <button type="button" class="swatch" style="background:#1d4ed8" data-value="Blu" aria-selected="false" title="Blu"></button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Variante corrente</span>
              <div class="inline-flex items-center gap-2">
                <button type="button" class="step" data-draft-stepper data-delta="-1">–</button>
                <span class="min-w-[1.5ch] text-center" data-draft-qty>0</span>
                <button type="button" class="step" data-draft-stepper data-delta="1">+</button>
              </div>
            </div>
            <button type="button" class="btn btn-ghost w-full" data-add-variant>+ Aggiungi variante</button>
            <div class="space-y-2" data-list></div>
          </div>
        </article>

        <!-- DOLCI -->
        <article id="card-dolce" class="bg-white rounded-2xl card overflow-hidden" data-kind="dolce">
          <!-- Inserisci QUI l'URL dell'immagine dolci -->
          <img id="img-dolce" class="w-full aspect-square object-cover" alt="Dolci" src="https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/dolci.jpg" data-zoomable/>
          <div class="p-4 space-y-4">
            <header class="flex items-center justify-between">
              <h3 class="font-semibold">Dolci</h3>
              <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-800 border border-amber-200">tradizione</span>
            </header>
            <p class="text-sm text-slate-600">Dolci della tradizione natalizia, per condividere il sapore autentico delle feste.</p>
            <div>
              <div class="text-xs text-slate-500 mb-2">Tipo</div>
              <div class="flex flex-wrap gap-2" data-chip-group="tipo">
                <button type="button" class="chip" aria-pressed="true" data-value="Pandoro classico">Pandoro classico</button>
                <button type="button" class="chip" aria-pressed="false" data-value="Pandoro al cioccolato">Pandoro al cioccolato</button>
                <button type="button" class="chip" aria-pressed="false" data-value="Panettone">Panettone</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Variante corrente</span>
              <div class="inline-flex items-center gap-2">
                <button type="button" class="step" data-draft-stepper data-delta="-1">–</button>
                <span class="min-w-[1.5ch] text-center" data-draft-qty>0</span>
                <button type="button" class="step" data-draft-stepper data-delta="1">+</button>
              </div>
            </div>
            <button type="button" class="btn btn-ghost w-full" data-add-variant>+ Aggiungi variante</button>
            <div class="space-y-2" data-list></div>
          </div>
        </article>

      </div>
    </section>

    <!-- PREORDINA + RIEPILOGO -->
    <section id="preordina" class="py-10">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 bg-white rounded-2xl card p-5">
          <h2 class="text-xl font-bold">I tuoi dati</h2>
          <p class="text-sm text-slate-600 mb-4">Ti ricontatteremo per conferma prima dell'ordine vero.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-600">Nome</label>
              <input id="nome" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Es. Maria"/>
            </div>
            <div>
              <label class="text-xs text-slate-600">Cognome</label>
              <input id="cognome" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Es. Rossi"/>
            </div>
            <div class="md:col-span-2">
              <label class="text-xs text-slate-600">Cellulare</label>
              <input id="cellulare" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Es. 3331234567"/>
            </div>
            <div class="md:col-span-2">
              <label class="text-xs text-slate-600">Seminarista di riferimento</label>
              <select id="seminarista" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-400"></select>
            </div>
            <div id="seminaristaAltroWrap" class="hidden md:col-span-2">
              <label class="text-xs text-slate-600">Altro seminarista</label>
              <input id="seminarista_altro" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Nome e cognome"/>
            </div>
          </div>
          <div class="mt-4 flex items-start gap-3">
            <input type="checkbox" id="consenso" class="mt-1 h-4 w-4"/>
            <label for="consenso" class="text-sm">Acconsento al trattamento dei dati per finalità organizzative della raccolta (GDPR).</label>
          </div>
          <div class="mt-5 flex items-center justify-between gap-3">
            <div class="text-xs text-slate-500">Stato: <span id="status">in attesa</span></div>
            <button id="submitBtn" class="btn btn-primary">Invia preordine</button>
          </div>
          <div id="result" class="text-sm mt-3 text-slate-700"></div>
        </div>
        <aside class="bg-white rounded-2xl card p-5">
          <h3 class="font-semibold">Riepilogo</h3>
          <div class="mt-2 text-sm text-slate-600 space-y-1">
            <div class="flex justify-between"><span>Birra</span><span id="sum-birra">0</span></div>
            <div class="flex justify-between"><span>Felpa</span><span id="sum-felpa">0</span></div>
            <div class="flex justify-between"><span>Cappello</span><span id="sum-cappello">0</span></div>
            <div class="flex justify-between"><span>Dolce</span><span id="sum-dolce">0</span></div>
            <hr class="my-2 border-slate-200"/>
            <div class="flex justify-between font-semibold"><span>Totale stimato</span><span id="totaleSide">€ 0,00</span></div>
          </div>
          <p class="mt-3 text-xs text-slate-500">È una stima: l’ordine verrà confermato con il tuo seminarista.</p>
        </aside>
      </div>
    </section>

    <!-- CAUSA -->
    <section id="causa" class="pb-16">
      <div class="rounded-2xl overflow-hidden mb-6 card">
        <!-- Inserisci QUI l'URL dell'immagine causa -->
        <div class="h-40 md:h-56 w-full bg-cover bg-center relative" id="causaBanner" style="background-image:url('https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/causa.jpg')">
          <div class="absolute inset-0 bg-red-900/30 mix-blend-multiply"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center text-white">
              <div class="text-sm uppercase tracking-widest opacity-90">Insieme per la</div>
              <div class="text-2xl md:text-3xl font-extrabold">Terra Santa</div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl card p-6">
        <h2 class="text-xl font-bold">Perché questa raccolta?</h2>
        <p class="mt-2 text-slate-600">Come comunità del Seminario, in occasione di Avvento e Natale desideriamo sostenere progetti in Terra Santa. I fondi raccolti contribuiranno a iniziative caritative, educative e di assistenza. Grazie ai tuoi preordini possiamo pianificare al meglio gli acquisti, ridurre sprechi e massimizzare l'aiuto concreto.</p>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="mt-10 bg-slate-900 text-slate-100">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-8 flex flex-col items-center space-y-2 text-center">
      <!-- Inserisci QUI lo stesso URL del logo se vuoi -->
      <img id="logoFooter" alt="Logo Seminario" class="h-8 w-auto opacity-95" src="https://raw.githubusercontent.com/gamislavoro/gamisavvento/refs/heads/main/logo.png"/>
      <div>Via Papa Pio XI, 32 - Venegono Inferiore (VA)</div>
      <div class="text-xs opacity-80">© <span id="yearNow"></span> GAMis - Seminario Arcivescovile di Milano</div>
    </div>
  </footer>

<script>
// ===== CONFIG =====
const ENDPOINT = "https://script.google.com/a/macros/seminario.milano.it/s/AKfycbyLq5FvkCvL50Eqc0ndTtHUSQuOKnOsKQK9wW5JgsnbzLQomnO4U6FpAUiUcWa-r2QNqw/exec"; // <-- sostituisci con l'URL /exec della tua Web App

// (RIMOSSI: IMAGES, LOGO_URL, setImgSrc, setBgImage, IMG_FALLBACK, setup())

const SEMINARISTI = ["— Seleziona —","Abbate don Nikolas", "Angelini don Andrea", "Bassi Andrea", "Bergamini don Gioele", "Bianchi don Giuseppe", "Bisi Federico", "Bolaños Josè", "Brancè don Samuele", "Caholo Gilberto", "Capizzi Emanuele", "Carchedi Davide", "Cardani Lorenzo", "Combi Fabio", "Conti Giacomo", "Corti Giovanni", "Crivellari Matteo", "Erroi Filippo", "Federico Bisi", "Ferrera Pietro", "Frattolillo don Nicolò", "Freddi Giacomo", "Garzone Alessandro", "Gazzoli Daniele", "Giovenzana Francesco", "Girelli Simone", "Gorno Riccardo", "Guido don Emanuele", "Landini Marco", "Lattuada Stefano", "Maccà don Paolo", "Macchi don Paolo", "Magistrelli don Stefano", "Marchiori Manuel", "Mariani Massimiliano", "Martinelli Samuele", "Mbala Simon", "Meda Francesco", "Mesiano Lorenzo", "Molteni don Lorenzo", "Nossa Alessandro", "Orfano Michele", "Pagani Carlo", "Palazzo Andrea", "Pandolfi Andrea", "Parini Giovanni", "Pasquot Filippo", "Perego Gianluca", "Rossi Alessandro", "Santambrogio Tommaso", "Sinigaglia Francesco", "Swich don Andrea", "Tamburrino Stefano", "Tchingui Moises", "Valli Giovanni", "Vicini Alessio", "Zannini Alessandro", "Zappaterra Matteo","Altro…"];

// CONFIG prodotti + prezzi centralizzati (immutati)
const OPTIONS = {
  birra:   { price: 10, chipGroups: { formato: ["Cassa da 6"] }, swatchGroups: {} },
  felpa:   { price: 25,  chipGroups: { taglia: ["S","M","L","XL","XXL"] },
             swatchGroups: { colore: [
               {label:"Nero",hex:"#111827"},{label:"Grigio",hex:"#cbd5e1"},
               {label:"Bordeaux",hex:"#7f1d1d"},{label:"Verde bosco",hex:"#14532d"},
               {label:"Blu navy",hex:"#1e3a8a"} ] } },
  cappello:{ price: 12,  chipGroups: {}, swatchGroups: { colore: [
               {label:"Nero",hex:"#111827"},{label:"Grigio",hex:"#cbd5e1"},
               {label:"Rosso",hex:"#ef4444"},{label:"Verde",hex:"#16a34a"},
               {label:"Blu",hex:"#1d4ed8"} ] } },
  dolce:   { price: 10,  chipGroups: { tipo: ["Pandoro classico","Pandoro al cioccolato","Panettone"] },
             swatchGroups: {} }
};

// ===== STATO =====
const state = {
  birra:[], felpa:[], cappello:[], dolce:[],
  draft:{ birra:{formato:'Cassa da 6',qty:0}, felpa:{colore:'Nero',taglia:'S',qty:0}, cappello:{colore:'Nero',qty:0}, dolce:{tipo:'Pandoro classico',qty:0} }
};

// ===== UTILS =====
const eur = (n)=> (Number.isFinite(n)?n:0).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
const qtySum = (arr)=> Array.isArray(arr)? arr.reduce((a,i)=> a + (parseFloat(i.qty)||0), 0) : 0;
const qtyAll = (k)=> qtySum(state[k]) + (parseFloat(state.draft[k]?.qty)||0);
const price = (k)=> parseFloat(OPTIONS[k]?.price)||0;
const total = ()=> ['birra','felpa','cappello','dolce'].reduce((s,k)=> s + qtyAll(k)*price(k), 0);

function refresh(){
  const t = total();
  const t1=document.getElementById('totaleTop'); if(t1) t1.textContent='Totale stimato: '+eur(t);
  const t2=document.getElementById('totaleSide'); if(t2) t2.textContent='Totale stimato: '+eur(t);
  const setLine=(id,kind)=>{
    const q = qtyAll(kind);
    const varianti = state[kind].length + ((parseFloat(state.draft[kind]?.qty)||0) > 0 ? 1 : 0);
    const el=document.getElementById(id); if(el) el.textContent = `${q} pz / ${varianti} varianti`;
  };
  setLine('sum-birra','birra'); setLine('sum-felpa','felpa'); setLine('sum-cappello','cappello'); setLine('sum-dolce','dolce');
}

function renderList(root, kind){
  const box = root.querySelector('[data-list]');
  const items = state[kind];
  box.innerHTML = items.map((it,idx)=>{
    const label = kind==='birra' ? `${it.qty} × ${it.formato}`
      : kind==='felpa' ? `${it.qty} × Felpa, ${it.colore} ${it.taglia}`
      : kind==='cappello' ? `${it.qty} × Cappello, ${it.colore}`
      : `${it.qty} × ${it.tipo}`;
    return `<div class="flex items-center justify-between rounded-xl border border-slate-200 px-3 py-2" data-idx="${idx}">
      <span class="text-sm">${label}</span>
      <span class="inline-flex items-center gap-2">
        <button type="button" class="step" data-row-step="-1">–</button>
        <button type="button" class="step" data-row-step="1">+</button>
        <button type="button" class="px-2 py-1 rounded-lg border border-slate-200" data-row-remove>Rimuovi</button>
      </span>
    </div>`;
  }).join('');
}

function bindCard(kind){
  const root = document.getElementById(`card-${kind}`);
  const d = state.draft[kind];
  // chips
  root.querySelectorAll('[data-chip-group]').forEach(group=>{
    group.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip'); if(!btn) return;
      group.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      d[group.getAttribute('data-chip-group')] = btn.getAttribute('data-value');
      refresh();
    });
  });
  // swatches
  root.querySelectorAll('[data-swatch-group]').forEach(group=>{
    group.addEventListener('click', (e)=>{
      const sw = e.target.closest('.swatch'); if(!sw) return;
      group.querySelectorAll('.swatch').forEach(s=>s.setAttribute('aria-selected','false'));
      sw.setAttribute('aria-selected','true');
      d[group.getAttribute('data-swatch-group')] = sw.getAttribute('data-value');
      refresh();
    });
  });
  // draft stepper
  root.querySelectorAll('[data-draft-stepper]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const delta = parseInt(btn.getAttribute('data-delta'),10);
      d.qty = Math.max(0,(parseFloat(d.qty)||0)+delta);
      const qEl = root.querySelector('[data-draft-qty]'); if(qEl) qEl.textContent = d.qty;
      refresh();
    });
  });
  // add variant
  const addBtn = root.querySelector('[data-add-variant]');
  if(addBtn){
    addBtn.addEventListener('click', ()=>{
      if(!d.qty || d.qty<=0){ refresh(); return; }
      const list = state[kind];
      const same = list.find(it=> Object.keys(d).every(k=> k==='qty' ? true : it[k]===d[k]));
      if(same) same.qty += d.qty; else list.push({...d});
      d.qty = 0; const qEl = root.querySelector('[data-draft-qty]'); if(qEl) qEl.textContent = '0';
      renderList(root, kind); refresh();
    });
  }
  // list handlers
  const listEl = root.querySelector('[data-list]');
  if(listEl){
    listEl.addEventListener('click', (e)=>{
      const line = e.target.closest('[data-idx]'); if(!line) return;
      const idx = +line.getAttribute('data-idx');
      if(e.target.closest('[data-row-step]')){
        const delta = +e.target.closest('[data-row-step]').getAttribute('data-row-step');
        state[kind][idx].qty = Math.max(0,(parseFloat(state[kind][idx].qty)||0)+delta);
        if(state[kind][idx].qty===0) state[kind].splice(idx,1);
        renderList(root, kind); refresh();
      }
      if(e.target.closest('[data-row-remove]')){
        state[kind].splice(idx,1); renderList(root, kind); refresh();
      }
    });
  }
}

// ===== Inizializzazione (senza setup) =====
// 1) bind & render liste prodotti
['birra','felpa','cappello','dolce'].forEach(k=>{ bindCard(k); renderList(document.getElementById(`card-${k}`),k); });

// 2) select seminaristi + campo "Altro"
(function(){
  const sel = document.getElementById('seminarista');
  if(sel){
    SEMINARISTI.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
    sel.addEventListener('change', ()=>{
      const wrap = document.getElementById('seminaristaAltroWrap');
      if(wrap) wrap.classList.toggle('hidden', !sel.value.toLowerCase().includes('altro'));
    });
  }
})();

// 3) anno corrente nel footer
(function(){ const y = document.getElementById('yearNow'); if(y) y.textContent = new Date().getFullYear(); })();

// 4) totale iniziale
refresh();

// ===== INVIO =====
const submitBtn = document.getElementById('submitBtn');
if(submitBtn){
  submitBtn.addEventListener('click', async ()=>{
    const nome = document.getElementById('nome').value.trim();
    const cognome = document.getElementById('cognome').value.trim();
    const cell = document.getElementById('cellulare').value.trim();
    const semSel = document.getElementById('seminarista').value;
    const semAltro = document.getElementById('seminarista_altro').value.trim();
    const seminarista = (!semSel || semSel==='— Seleziona —' || semSel.toLowerCase().includes('altro')) ? semAltro : semSel;
    const pezzi = qtyAll('birra')+qtyAll('felpa')+qtyAll('cappello')+qtyAll('dolce');
    const result = document.getElementById('result');
    const status = document.getElementById('status');
    const err = !nome||!cognome ? 'Compila Nome e Cognome.' : !/^[+]?\d{7,15}$/.test(cell.replace(/\s+/g,'')) ? 'Inserisci un numero valido (7–15 cifre).' : !seminarista ? 'Seleziona/inserisci un seminarista.' : pezzi===0 ? 'Indica almeno un prodotto (quantità > 0).' : !document.getElementById('consenso').checked ? 'Devi acconsentire al trattamento dati (GDPR).' : null;
    if(err){ status.textContent='errore'; result.textContent=err; return; }

    if(!ENDPOINT || /YOUR_APPS_SCRIPT/i.test(ENDPOINT)){
      status.textContent='errore';
      result.textContent="Configurazione mancante: incolla l'URL /exec della Web App di Apps Script in ENDPOINT.";
      return;
    }

    status.textContent='invio…'; result.textContent='Invio in corso…';
    const payload = {
      timestamp:new Date().toISOString(), nome,cognome,cellulare:cell, seminarista,
      birra_items: state.birra, felpa_items: state.felpa, cappello_items: state.cappello, dolce_items: state.dolce,
      totale_stimato: total()
    };
    try{
      const res = await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if(data.status==='ok'){
        status.textContent='inviato'; result.textContent='Grazie! Preordine registrato.';
        ['birra','felpa','cappello','dolce'].forEach(k=>{ state[k]=[]; state.draft[k].qty=0; renderList(document.getElementById(`card-${k}`),k); const el=document.querySelector(`#card-${k} [data-draft-qty]`); if(el) el.textContent='0'; });
        refresh();
      } else { throw new Error(data.message||'Errore generico'); }
    }catch(e){
      status.textContent='errore';
      result.textContent='Invio fallito. ' + (e?.message||'Errore di rete/CORS');
    }
  });
}

  // Auto-hide header on scroll down, show on scroll up
(function () {
  const header = document.querySelector('header');
  if (!header) return;

  let lastY = window.scrollY;
  window.addEventListener('scroll', () => {
    const y = window.scrollY;
    const goingDown = y > lastY;
    // soglia di attivazione (80px) per evitare "salti" subito
    if (goingDown && y > 80) {
      header.classList.add('-translate-y-full');
    } else {
      header.classList.remove('-translate-y-full');
    }
    lastY = y;
  }, { passive: true });
})();

// Creazione lightbox
const lightbox = document.createElement('div');
lightbox.id = 'lightbox';
lightbox.className = 'fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50';
lightbox.innerHTML = '<img class="max-h-[90%] max-w-[90%] rounded-xl shadow-lg"/>';
document.body.appendChild(lightbox);

const lightboxImg = lightbox.querySelector('img');

// Chiudi lightbox al click
lightbox.addEventListener('click', () => {
  lightbox.classList.add('hidden');
});

// Aggiungi listener a tutte le immagini con data-zoomable
document.querySelectorAll('img[data-zoomable]').forEach(img => {
  img.addEventListener('click', () => {
    lightboxImg.src = img.src;
    lightbox.classList.remove('hidden');
  });
});

  
// DEBUG globale
window.addEventListener('error', (e)=>{
  const bar=document.getElementById('jsError');
  const msg=document.getElementById('jsErrorMsg');
  if(bar&&msg){ bar.style.display='block'; msg.textContent=(e?.message||'Errore sconosciuto'); }
});
</script>
</body>
</html>
